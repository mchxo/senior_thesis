---
title: "mixed_effects_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="/home/michael_xiao/T/st")
getwd()
```






```{r}
# load packages and data
require("sf")
require(sp)
require(tidyverse)
require(plotly)
require(mgcv)
require(GGally)
require(car)
require(gstat)
require(iml)
require(ggthemes)
require(mgcViz)

data = read_sf("/home/michael_xiao/R/s/Final_Data/update_data2.shp")
data = data %>% filter((tree > 0.5)|(shrub > 0.6))
data = data %>% rename(y2010.pPBA=pPBA10, y2011.pPBA=pPBA11, y2012.pPBA=pPBA12, y2013.pPBA=pPBA13, 
                       y2014.pPBA=pPBA14, y2015.pPBA=pPBA15, y2016.pPBA=pPBA16, y2017.pPBA=pPBA17, 
                       y2018.pPBA=pPBA18, y2019.pPBA=pPBA19,
                       y2010.wf = wf2010, y2011.wf = wf2011, y2012.wf = wf2012, y2013.wf = wf2013, 
                       y2014.wf = wf2014, y2015.wf = wf2015, y2016.wf = wf2016, y2017.wf = wf2017, 
                       y2018.wf = wf2018, y2019.wf = wf2019, 
                       y2011.pb = pb2011, y2012.pb = pb2012, y2013.pb = pb2013, y2014.pb = pb2014, 
                       y2015.pb = pb2015, y2016.pb = pb2016, y2017.pb = pb2017, y2018.pb = pb2018, 
                       y2019.pb = pb2019, y2010.pb = pb2010, 
                       y2010.pWFA = pWFA2010, y2011.pWFA = pWFA2011, y2012.pWFA = pWFA2012, y2013.pWFA = pWFA2013, 
                       y2014.pWFA = pWFA2014, y2015.pWFA = pWFA2015, y2016.pWFA = pWFA2016, y2017.pWFA = pWFA2017, 
                       y2018.pWFA = pWFA2018, y2019.pWFA = pWFA2019,
                       y2010.temp = Avg_y2010_, y2011.temp = Avg_y2011_, y2012.temp = Avg_y2012_, y2013.temp = Avg_y2013_, 
                       y2014.temp = Avg_y2014_, y2015.temp = Avg_y2015_, y2016.temp = Avg_y2016_, y2017.temp = Avg_y2017_, 
                       y2018.temp = Avg_y2018_, y2019.temp = Avg_y2019_, 
                       precip = ppt, temperature = temp)
```

```{r}
# read in fire data
fire = read_sf("/home/michael_xiao/R/s/fire_data/fire20_1.gdb", layer="firep20_1")
fire$YEAR_ = as.numeric(fire$YEAR_)
fire = fire %>% filter((YEAR_ >= 2010) & (YEAR_ <= 2019))

# clip fire

```

```{r}
# encode lags
for (y in 2013:2019) {
  data[,paste("y", y, ".pb1Prev", sep="")] = data[,paste("y", y-1, ".pPBA", sep="")] %>% st_drop_geometry() %>% pull()
  data[,paste("y", y, ".pb2Prev", sep="")] = data[,paste("y", y-2, ".pPBA", sep="")] %>% st_drop_geometry() %>% pull()
  data[,paste("y", y, ".pb3Prev", sep="")] = data[,paste("y", y-3, ".pPBA", sep="")] %>% st_drop_geometry() %>% pull()
}

# shift aspect
data$aspect = abs(180 - abs(data$aspect-225))
# 
data.cent = data$geometry %>% st_centroid() %>% st_coordinates()
data$CENTROID_X = data.cent[,1]
data$CENTROID_Y = data.cent[,2]
```




```{r}
# drop monthly wf, pb, wf_count, pb_count, annual_wf, sd_wf, nMonth_wf, annual_pb, sd_pb, wf
drops = c(paste("wf", 1:12, sep=""), paste("pb", 1:12, sep=""), "wf_count", "pb_count", "annual_wf", 
          "sd_wf", "nMonth_wf", "annual_pb", "sd_pb","nMonth_pb", "pb_score", "fire_score")
data = data[,!names(data) %in% drops]
data = st_drop_geometry(data)

# reshape data
dataLong = data %>% 
  pivot_longer(starts_with("y"), names_to=c("year", ".value"), names_pattern="y(201\\d)[\\.|_](.*)")

dataLong = dataLong %>% filter(year >= 2013)
dataLong$year = as.factor(dataLong$year)
dataLong$wf = as.numeric(dataLong$pWFA > 0)

# encode deviances
dataLong$dTemp = dataLong$temp - dataLong$temperature
dataLong$dPpt = dataLong$ppt - dataLong$precip
dataLong$dVPM = dataLong$vpma - dataLong$vpmax

dataLong
```





"s(ppt) + s(temp) + s(vpmax) + s(vpmin) + s(elevation) + s(perc_cloud) + s(wind_speed) + s(pop_den) +
    s(pFederal) + s(pState) + s(pCounty) + s(pCity) + s(pNP) + s(pSD) + s(pPrivate) + s(dRoad) + s(dTrail) +
    s(dPowerLine) + s(shrub) + s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X) + s(CENTROID_Y) + year + s(pPBA)"
    
  "ppt + temp + vpmax + vpmin + elevation + perc_cloud + wind_speed + pop_den + pFederal + pState + pCounty + pCity + pNP + pSD + pPrivate + dRoad + dTrail + dPowerLine + shrub + tree + herb + slope + aspect + CENTROID_X + CENTROID_Y + year + pPBA"

```{r}
# vif analysis
# removed: vpmax, all but pFederal and pState, elevation, shrub
vif_form = formula(paste("wf~", "ppt + temp + vpmin  + perc_cloud + wind_speed + pop_den + pFederal + pState +dRoad + dTrail + dPowerLine + tree + herb + slope + aspect + CENTROID_X + CENTROID_Y + pPBA", sep=""))
vif_model = lm(vif_form, data=dataLong)
car::vif(vif_model)
```





```{r}
# fit naive gam: make formula
naive_vars = colnames(dataLong)[-which(colnames(dataLong) == "wf" | colnames(dataLong) == "pWFA" | colnames(dataLong) == "pb")]
for_pasting = paste(paste("s(", naive_vars, ")", sep=""), collapse=" + ")
naive_form = formula(paste("wf~",   "s(ppt, bs='re') + s(vpma, bs='re') + s(perc_cloud) + s(wind_speed) + 
s(pop_den) +
    s(pFederal) + s(pState) + s(dRoad) + s(dTrail) +
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + 
    s(year, bs='re') + s(year, temp, bs='re') + s(pPBA) + s(pb1Prev) + s(pb2Prev) + s(pb3Prev)", sep=""))

naive_form
```
```{r}
# fit naive gam: fitting
naive_gam = gam(naive_form, data=dataLong, family=binomial)
summary(naive_gam)
```

```{r}
naive_gam$coefficients
```


```{r}
viz = getViz(naive_gam)
plot(sm(viz, select=1))
```






```{r}
plot(naive_gam, scale=0, rug=T)
```

Model 1: only random intercept on year (G Model)
```{r}
model1_form = formula(paste("wf~",   "s(ppt) + s(vpma) + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) +
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + 
    s(year, bs='re') + s(temp) + s(pPBA) + s(pb1Prev) + s(pb2Prev) + s(pb3Prev)", sep=""))

model1 = gam(model1_form, data=dataLong, family=binomial)
summary(model1)
```


Model 2: add anomoly detection (G Model)
```{r}

model2_form = formula(paste("wf~",   "s(ppt) + s(vpma) + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + 
    s(year, bs='re') + s(temp) + s(pPBA) + s(pb1Prev) + s(pb2Prev) + s(pb3Prev)", sep=""))

model2 = gam(model2_form, data=dataLong, family=binomial)
summary(model2)
```


Model 3: Random slope (Linear?)
```{r}
model3_form = formula(paste("wf~",   "s(ppt, year, bs='re') + s(vpma, year, bs='re') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + s(temp, year, bs='re') + s(pPBA) + s(pb1Prev) + s(pb2Prev) + s(pb3Prev) + s(ppt) + s(vpma) + s(temp)", sep=""))

model3 = gam(model3_form, data=dataLong, family=binomial)
summary(model3)
```


Model 4: Random Intercept + Slope
```{r}
model4_form = formula(paste("wf~",   "s(ppt, year, bs='re') + s(vpma, year, bs='re') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + s(temp, year, bs='re') + s(pPBA) + s(pb1Prev) + s(pb2Prev) + s(pb3Prev) + s(ppt) + s(vpma) + s(temp) + s(year, bs='re')", sep=""))

model4 = gam(model4_form, data=dataLong, family=binomial)
summary(model4)
```


Model 5: Random Smooth (GS Model)
```{r}
model5_form = formula(paste("wf~",   "s(ppt, year, bs='fs') + s(vpma, year, bs='fs') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + s(temp, year, bs='fs') + s(pPBA) + s(pb1Prev) + s(pb2Prev) + s(pb3Prev) + s(ppt) + s(vpma) + s(temp)", sep=""))

model5 = gam(model5_form, data=dataLong, family=binomial)
summary(model5)
```

Model 6: Additional Smoothers on Fire Stuff (GS Model)
```{r}
model6_form = formula(paste("wf~",   "s(ppt, year, bs='fs') + s(vpma, year, bs='fs') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + s(temp, year, bs='fs') + s(pPBA, year, bs='fs') + s(pb1Prev, year, bs='fs') + s(pb2Prev, year, bs='fs') + s(pb3Prev, year, bs='fs') + s(ppt) + s(vpma) + s(temp)", sep=""))

model6 = gam(model6_form, data=dataLong, family=binomial)
summary(model6)
```

Model 7: GI Model (different penalty terms)

```{r}
model7_form = formula(paste("wf~",   "s(ppt, by=year) + s(vpma, by=year) + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y) + s(temp, by=year) + s(pPBA, by=year) + s(pb1Prev, by=year) + s(pb2Prev, by=year) + s(pb3Prev, by=year) + s(ppt) + s(vpma) + s(temp) + s(year, bs='re')", sep=""))

model7 = gam(model7_form, data=dataLong, family=binomial, method="REML")
summary(model7)
```

Model 8: Cyclic for aspect (GS Model)

```{r}
model8_form = formula(paste("wf~",   "s(ppt, year, bs='fs') + s(vpma, year, bs='fs') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp) + s(dPpt) + s(dVPM)+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect, bs='cc') + s(CENTROID_X, CENTROID_Y) + s(temp, year, bs='fs') + s(pPBA, year, bs='fs') + s(pb1Prev, year, bs='fs') + s(pb2Prev, year, bs='fs') + s(pb3Prev, year, bs='fs') + s(ppt) + s(vpma) + s(temp)", sep=""))

ctrl <- gam.control(trace = TRUE)
model8 = gam(model8_form, data=dataLong, family=binomial, knots=list(aspect=c(0,360)), control = ctrl)
summary(model8)
```

Model 9: GS Model with deviance factored
```{r}
model9_form = formula(paste("wf~",   "s(ppt, year, bs='fs') + s(vpma, year, bs='fs') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp, year, bs='fs') + s(dPpt, year, bs='fs') + s(dVPM, year, bs='fs')+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + s(CENTROID_X, CENTROID_Y, year, bs='fs') + s(temp, year, bs='fs') + s(pPBA, year, bs='fs') + s(pb1Prev, year, bs='fs') + s(pb2Prev, year, bs='fs') + s(pb3Prev, year, bs='fs') + s(ppt) + s(vpma) + s(temp) + s(dTemp) + s(dPpt) + s(dVPM)", sep=""))

model9 = gam(model9_form, data=dataLong, family=binomial)
summary(model9)
```

Model 10: Tensor product of year and coords

```{r}
model10_form = formula(paste("wf~",   "s(ppt, year, bs='fs') + s(vpma, year, bs='fs') + s(perc_cloud) + s(wind_speed) + s(pop_den) + s(pFederal) + s(pState) + s(dRoad) + s(dTrail) + s(dTemp, year, bs='fs') + s(dPpt, year, bs='fs') + s(dVPM, year, bs='fs')+
    s(dPowerLine) +  s(tree) + s(herb) + s(slope) + s(aspect) + te(CENTROID_X, CENTROID_Y, year, bs='fs') + s(temp, year, bs='fs') + s(pPBA, year, bs='fs') + s(pb1Prev, year, bs='fs') + s(pb2Prev, year, bs='fs') + s(pb3Prev, year, bs='fs') + s(ppt) + s(vpma) + s(temp) + s(dTemp) + s(dPpt) + s(dVPM)", sep=""))

model10 = gam(model10_form, data=dataLong, family=binomial)
summary(model10)
```








```{r}
res = model9$residuals
dataLong$res = res
x = dataLong$CENTROID_X
y = dataLong$CENTROID_Y
coordinates(dataLong) = ~x+y
v = variogram(res~1, data=dataLong)

v_dir = variogram(res~1, data=dataLong, alpha=c(0,45,90,130))
plot(v)
plot(v_dir)
plot_map(data %>% filter(res>0), "res", direction=-1)
```






Model Comparison

```{r}
AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10)
```

```{r}
viz = getViz(model9)
plot(sm(viz, select=20)) + 
  l_fitLine()
```





```{r}
plot(model9,scale=0, rug=T)
```
















```{r}
# mapping the variables
plot_map = function(data, var, type="c", direction=1) {
  if (type == "c") {
    ggplot(data=data) +
      geom_sf(aes(fill=!!sym(var), color=!!sym(var))) +
      scale_fill_viridis_c(direction=direction) +
      scale_color_viridis_c(direction=direction)
  } else if (type == "d") {
    ggplot(data=data) +
      geom_sf(aes(fill=as.factor(!!sym(var)), color=as.factor(!!sym(var)))) +
      scale_fill_viridis_d(direction=direction) +
      scale_color_viridis_d(direction=direction)
  }
}

plotFireVar = function(data, var, plot_title, legend_title) {
  ggplot() +
  geom_sf(data=data, aes(color=!!sym(var))) +
    scale_color_continuous(high = "#132B43", low = "#56B1F7", name=legend_title) +
  geom_sf(data=fire_loc, size=0.4, alpha=0.15, aes(fill="val"), color="red") +
    scale_fill_manual(values="black", labels="", guide=guide_legend(override.aes=list(size=2, alpha=1), title="Fire")) +
  ggtitle(plot_title)+
  theme_minimal()
}



dataPlot = read_sf("/home/michael_xiao/R/s/Final_Data/update_data2.shp")
dataPlot = dataPlot %>% filter((tree > 0.5)|(shrub > 0.6))

# make fire location
fire_loc = dataPlot %>% filter(wf_count >= 1) %>% pull(geometry) %>% st_centroid()
fire_loc = st_sf(fire_loc)
fire_loc$val = 1.5

# test on dtrail
ggplot() +
  geom_sf(data=dataPlot, aes(color=dTrail)) +
    scale_color_continuous(high = "#132B43", low = "#56B1F7", name="Distance(km)") +
  geom_sf(data=fire_loc, size=0.4, alpha=0.15, aes(fill="val"), color="red") +
    scale_fill_manual(values="black", labels="", guide=guide_legend(override.aes=list(size=2, alpha=1), title="Fire")) +
  ggtitle("Distance to Trails")+
  theme_minimal()


plotFireVar(dataPlot, "dTrail", plot_title = "Distance to Trail", legend_title = "Distance(km)")
ggsave("~/R/s/Plots/fire_var/dTrail.png")

colnames(dataPlot)

vars_to_plot = c("ppt", "temp", "vpmax", "elevation", "perc_cloud", "wind_speed", "pop_den", "pFederal", "pState", "dRoad", "dTrail", "dPowerLine", "annual_pb", "slope", "aspect")

plot_titles = c("Mean Annual Precipitation", "Mean Annual Temperature", "Mean Max VPD", "Elevation", "Cloud Coverage", "Wind Speed", "Population Density", "Proportion of Federally Owned Land", "Proportion of State Owned Land", "Distance to Road", "Distance to Trail", "Distance to Power Line", "Mean Annual Proportion Prescribed Burning", "Slope", "Aspect")

legend_titles = c("Precipitation(mm)", "Temperature(degree Celcius)", "VPD(hPA)", "Elevation(m)", "Cloud Coverage(proportion)", "Wind Speed(m/s)", "Population Density(persons/cell)", "Proportion of Federally Owned Land", "Proportion of State Owned Land", "Distance(km)", "Distance(km)", "Distance(km)", "Mean Annual Proportion Prescribed Burning", "Slope(degree)", "Aspect(folded degree)")

for (var in vars_to_plot) {
  print(var)
  pt = plot_titles[which(vars_to_plot == var)]
  lt = legend_titles[which(vars_to_plot == var)]
  plotFireVar(dataPlot, var, plot_title = pt, legend_title = lt)
  ggsave(paste("~/R/s/Plots/fire_var/", var, ".png"))
}
```


```{r}
gam.check(model9)
```


